<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ store.title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<section class="hero">
  <div class="hero-image">
    <img src="{{ store.hero_image }}" alt="店舗画像">
  </div>
  <div class="hero-text">
    <h1>{{ store.store_name }}<br><span>ご来店ありがとうございます</span></h1>
    <p>アンケートのご協力をお願いします。</p>
  </div>
</section>

<section class="survey">
    <form id="review-form">
        {% for q in store.questions %}
          {% if q.type == "select" %}
          <div class="form-group">
            <label for="{{ q.id }}">{{ q.label }}</label>
            <select id="{{ q.id }}" name="{{ q.id }}">
              <option value="">選択してください</option>
              {% for opt in q.options %}
              <option value="{{ opt }}">{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          {% elif q.type == "textarea" %}
          <div class="form-group">
            <label for="{{ q.id }}">{{ q.label }}</label>
            <textarea id="{{ q.id }}" name="{{ q.id }}" rows="6" placeholder="{{ q.placeholder }}"></textarea>
          </div>
          {% endif %}
        {% endfor %}
      
        <div class="form-group">
          <button type="button" class="generate-btn" onclick="handleSubmit()">回答</button>
        </div>
      </form>
</section>

<section class="result-section">
  <p class="result-label"><strong>こちらの口コミ案をよろしければお使いください</strong></p>
  <textarea class="result-box" id="reviewText"></textarea>
  <button class="copy-btn" onclick="copyToClipboard()">コピー</button>
  <div id="copyMessage" class="copy-message">コピーしました！</div>
  <div class="post-invite"><p><strong>こちらから投稿お願いします。</strong></p></div>
  <div class="link-buttons">
    <a href="{{ store.google_link }}" target="_blank">
      <img src="{{ store.google_img }}" alt="Google" class="post-icon-1">
    </a>
    <a href="{{ store.store_link }}" target="_blank">
        <img src="{{ store.store_logo }}" alt="投稿サイト" class="post-icon-2">
      </a>      
  </div>
</section>

<footer class="footer">
  <p>{{ store.store_name }}</p>
</footer>

<script>
  function copyToClipboard() {
    const text = document.getElementById("reviewText").value;
    if (!text) return;
    navigator.clipboard.writeText(text).then(() => {
      const msg = document.getElementById("copyMessage");
      msg.classList.add("show");
      setTimeout(() => msg.classList.remove("show"), 1500);
    });
  }

  async function handleSubmit() {
    const formData = {};
    document.querySelectorAll("#review-form select, #review-form textarea").forEach(el => {
      formData[el.name] = el.value;
    });

    const values = Object.entries(formData).map(([k, v]) => `- ${k}: ${v}`).join("\n");

    const prompt = `以下はお客様が店舗でサービスを体験された際のアンケート回答内容です。
    \n${values}\n\n
    この内容をもとに、実際に体験した一般のお客様が書いたような自然な日本語の口コミ文を1件のみ作成してください。
    口コミの内容は、アンケート内に記載された「5点満点のうちの評価点数」に必ず一致させてください。

    出力する口コミは、以下のルールに従ってください。数値の点数は口コミ内に書かず、内容やトーンで表現してください。

    1点：満足できなかった。やや否定的な印象だが、感情的にならず冷静なトーンで。おすすめしないニュアンス。文字数：約100文字

    2点：あまり満足できなかった。改善点に触れつつ、表現は控えめに。現時点では他人にすすめない印象。文字数：約100文字

    3点：平均的な満足度。良い点と気になった点の両方に軽く触れる。ネガティブな表現はマイルドに。文字数：約200文字

    4点：満足できた。全体的に好印象。再訪の可能性があるような前向きな感想に。文字数：約400文字

    5点：非常に満足した。人にすすめたい、また利用したいという積極的な感想を表現。文字数：約400文字

    ⚠️ 注意：必ず1つの評価点に基づいた口コミのみを出力してください。複数の点数に基づく内容を混在させないでください。`; 

    const reviewBox = document.getElementById("reviewText");
    reviewBox.value = "生成中...";

    try {
      const response = await fetch("/api/generate", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      const data = await response.json();
      reviewBox.value = data.result || "生成に失敗しました。";
    } catch (err) {
      console.error("エラー:", err);
      reviewBox.value = "エラーが発生しました。";
    }
  }
</script>

</body>
</html>
