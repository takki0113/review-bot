<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ store.store_name }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<section class="hero">
  <div class="hero-image">
    <img src="{{ store.hero_image }}" alt="店舗画像">
  </div>
  <div class="hero-text">
    <h1><span>ご来店ありがとうございます</span></h1>
    <p>アンケートのご協力をお願いします。</p>
  </div>
</section>

<section class="survey">
    <form id="review-form">
        {% for q in store.questions %}
          {% if q.type == "select" %}
          <div class="form-group">
            <label for="{{ q.id }}">{{ q.label }}</label>
            <select id="{{ q.id }}" name="{{ q.id }}">
              <option value="">選択してください</option>
              {% for opt in q.options %}
              <option value="{{ opt }}">{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          {% elif q.type == "textarea" %}
          <div class="form-group">
            <label for="{{ q.id }}">{{ q.label }}</label>
            <textarea id="{{ q.id }}" name="{{ q.id }}" rows="6" placeholder="{{ q.placeholder }}"></textarea>
          </div>
          {% endif %}
        {% endfor %}
      
        <div class="form-group">
          <button type="button" class="generate-btn" onclick="handleSubmit()">回答</button>
        </div>
      </form>
</section>

<section class="result-section">
  <p class="result-label"><strong>こちらの口コミ案をよろしければお使いください</strong></p>
  <textarea class="result-box" id="reviewText"></textarea>
  <button class="copy-btn" onclick="copyToClipboard()">コピー</button>
  <div id="copyMessage" class="copy-message">コピーしました！</div>
  <div class="post-invite"><p><strong>こちらから投稿お願いします。</strong></p></div>
  <div class="link-buttons">
    <a href="{{ store.google_link }}" target="_blank">
      <img src="{{ store.google_img }}" alt="Google" class="post-icon-1">
    </a>
    <a href="{{ store.store_link }}" target="_blank">
        <img src="{{ store.store_logo }}" alt="投稿サイト" class="post-icon-2">
    </a>      
  </div>
</section>

<footer class="footer">
  <p>{{ store.store_name }}</p>
</footer>

<script>
  async function handleSubmit() {
    const formData = {};
    document.querySelectorAll("#review-form select, #review-form textarea").forEach(el => {
      formData[el.name] = el.value;
    });

    const ratingRaw = formData["q1"];
    if (!ratingRaw || !ratingRaw.match(/^[1-5]点$/)) {
      alert("評価点数が正しく入力されていません。");
      return;
    }

    const rating = ratingRaw.replace("点", "");
    const promptMap = {
  "1": `100文字前後で、やや否定的で冷静なトーンの口コミを生成してください。
- 内容はおすすめしないことが自然に伝わるように。
- 感情的ではなく、体験に基づいた事実を淡々と述べてください。
- 文字数は100文字前後を目安にしつつ、最低でも80文字以上になるようにしてください。
- 文末は「定型的・AI的」な表現にならないよう注意し、体験の余韻や感想で自然に締めくくるようにしてください。
  - 例：「また行きたくなるお店です。」「ぜひ行ってみてください。」などは避ける。
- 「私は40代の男性です」「訪れたいと思います」のような不自然・説明調・硬すぎる表現は禁止。
- 口コミとして自然に読める口語調で、主語を省略しても構いません。
- 口コミ文のみを出力してください（説明や前置きは禁止）。`,

  "2": `100文字前後で、控えめに不満点を指摘する口コミを生成してください。
- 現時点ではおすすめしないという印象を自然に伝えてください。
- 丁寧な言葉づかいで、攻撃的にならないようにしてください。
- 文字数は100文字前後を目安にしつつ、最低でも80文字以上になるようにしてください。
- 文末は「定型的・AI的」な表現にならないよう注意し、体験の余韻や感想で自然に締めくくるようにしてください。
  - 例：「また行きたくなるお店です。」「ぜひ行ってみてください。」などは避ける。
- 「私は40代の男性です」「訪れたいと思います」のような不自然・説明調・硬すぎる表現は禁止。
- 口コミとして自然に読める口語調で、主語を省略しても構いません。
- 口コミ文のみを出力してください（説明や前置きは禁止）。`,

  "3": `150文字前後で、良かった点と気になる点をバランスよく含んだ口コミを生成してください。
- フラットな視点で、読者が参考にしやすい内容にしてください。
- 褒めすぎず、否定しすぎず、中立的で自然な文章を心がけてください。
- 文字数は150文字前後を目安にしつつ、最低でも130文字以上になるようにしてください。
- 文末は「定型的・AI的」な表現にならないよう注意し、体験の余韻や感想で自然に締めくくるようにしてください。
  - 例：「また行きたくなるお店です。」「ぜひ行ってみてください。」などは避ける。
- 「私は40代の男性です」「訪れたいと思います」のような不自然・説明調・硬すぎる表現は禁止。
- 口コミとして自然に読める口語調で、主語を省略しても構いません。
- 口コミ文のみを出力してください（説明や前置きは禁止）。`,

  "4": `300文字前後で、全体的に好印象で再訪したいというトーンの口コミを生成してください。
- 接客、店内の雰囲気、料理やサービスの印象に触れてください。
- 軽い気になる点があれば自然な流れで一言だけ触れても構いません（全体はポジティブ寄りに）。
- 文字数は300文字前後を目安にしつつ、最低でも250文字以上になるようにしてください。
- 文末は「定型的・AI的」な表現にならないよう注意し、体験の余韻や感想で自然に締めくくるようにしてください。
  - 例：「また行きたくなるお店です。」「ぜひ行ってみてください。」などは避ける。
- 「私は40代の男性です」「訪れたいと思います」のような不自然・説明調・硬すぎる表現は禁止。
- 口コミとして自然に読める口語調で、主語を省略しても構いません。
- 口コミ文のみを出力してください（説明や前置きは禁止）。`,

  "5": `400文字前後で、非常に満足し他人にもおすすめしたいというトーンの口コミを生成してください。
- 喜びや満足の気持ちは伝えつつ、表現は過剰にならないようにしてください（例：「最高」「絶対」「感動」などの多用は避ける）。
- サービス体験や料理の印象を、丁寧かつ具体的に描写してください。
- 全体の流れは「来店前の期待 → 店舗での体験 → 感想・満足度」が伝わるように構成してください。
- ポジティブで自然な日本語を使い、客観的な視点も含めて読んだ人が参考にしやすい口コミにしてください。
- 文末は「定型的・AI的」な表現にならないよう注意し、体験の余韻や感想で自然に締めくくるようにしてください。
  - 例：「また行きたくなるお店です。」「ぜひ行ってみてください。」などは避ける。
- 文字数は400文字前後を目安にしつつ、最低でも350文字以上になるようにしてください。
- 「私は40代の男性です」「訪れたいと思います」のような不自然・説明調・硬すぎる表現は禁止。
- 口コミとして自然に読める口語調で、主語を省略しても構いません。
- 口コミ文のみを出力してください（説明や前置きは禁止）。`
};



    const values = Object.entries(formData).map(([k, v]) => `- ${k}: ${v}`).join("\n");
    const basePrompt = `以下はお客様が店舗でサービスを体験された際のアンケート回答内容です：\n${values}\n\n`;
    const prompt = basePrompt + promptMap[rating];

    const reviewBox = document.getElementById("reviewText");
    reviewBox.value = "生成中...";

    try {
      const response = await fetch("/api/generate", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      const data = await response.json();
      reviewBox.value = data.result || "生成に失敗しました。";
    } catch (err) {
      console.error("エラー:", err);
      reviewBox.value = "エラーが発生しました。";
    }
  }

  function copyToClipboard() {
    const text = document.getElementById("reviewText").value;
    if (!text) return;

    navigator.clipboard.writeText(text)
      .then(() => {
        const msg = document.getElementById("copyMessage");
        msg.style.display = "block";
        setTimeout(() => msg.style.display = "none", 2000);
      })
      .catch(err => {
        console.error("コピー失敗:", err);
      });
  }
</script>

</body>
</html>
