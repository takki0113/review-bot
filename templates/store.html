<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ store.store_name }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<section class="hero">
  <div class="hero-image">
    <img src="{{ store.hero_image }}" alt="店舗画像">
  </div>
  <div class="hero-text">
    <h1><span>ご来店ありがとうございます</span></h1>
    <p>アンケートのご協力をお願いします。</p>
  </div>
</section>

<section class="survey">
    <form id="review-form">
        {% for q in store.questions %}
          {% if q.type == "select" %}
          <div class="form-group">
            <label for="{{ q.id }}">{{ q.label }}</label>
            <select id="{{ q.id }}" name="{{ q.id }}">
              <option value="">選択してください</option>
              {% for opt in q.options %}
              <option value="{{ opt }}">{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          {% elif q.type == "textarea" %}
          <div class="form-group">
            <label for="{{ q.id }}">{{ q.label }}</label>
            <textarea id="{{ q.id }}" name="{{ q.id }}" rows="6" placeholder="{{ q.placeholder }}"></textarea>
          </div>
          {% endif %}
        {% endfor %}
      
        <div class="form-group">
          <button type="button" class="generate-btn" onclick="handleSubmit()">回答</button>
        </div>
      </form>
</section>

{% if store.google_link and store.store_link %}
<section class="result-section">
  <p class="result-label"><strong>こちらの口コミ案をよろしければお使いください</strong></p>
  <textarea class="result-box" id="reviewText"></textarea>
  <button class="copy-btn" onclick="copyToClipboard()">コピー</button>
  <div id="copyMessage" class="copy-message">コピーしました！</div>
  <div class="post-invite"><p><strong>こちらから投稿お願いします。</strong></p></div>
  <div class="link-buttons">
    <a href="{{ store.google_link }}" target="_blank">
      <img src="{{ store.google_img }}" alt="Google" class="post-icon-1">
    </a>
    <a href="{{ store.store_link }}" target="_blank">
        <img src="{{ store.store_logo }}" alt="投稿サイト" class="post-icon-2">
    </a>      
  </div>
</section>
{% endif %}

<footer class="footer">
  <p>{{ store.store_name }}</p>
</footer>

<script>
  async function handleSubmit() {
    const formData = {};
    document.querySelectorAll("#review-form select, #review-form textarea").forEach(el => {
      formData[el.name] = el.value;
    });
  
    console.log("送信されたフォームデータ:", formData);
  
    const ratingRaw = formData["q1"];  // ← 評価点の質問ID。変わる場合はここを動的化してもOK
    if (!ratingRaw || !ratingRaw.match(/^[1-5]点$/)) {
      alert("評価点数が正しく入力されていません。");
      return;
    }
  
    const rating = ratingRaw.replace("点", ""); // "5点" → "5"
  
    const promptMap = {
      "1": `100文字前後で、やや否定的で冷静なトーンの口コミを生成してください。\n- 内容はおすすめしないことが伝わるもの。\n- 感情的ではなく、事実や体験ベースで表現してください。\n- 口コミ以外の余計な文言は含めないでください。`,
      "2": `100文字前後で、控えめに不満点を指摘する口コミを生成してください。\n- 現時点ではおすすめしないという印象で。\n- 課題があっても丁寧な言葉で伝えてください。\n- 口コミ以外の文言は禁止です。`,
      "3": `150文字前後で、良かった点と気になる点をバランスよく含んだ口コミを生成してください。\n- フラットな視点で、読者が参考にしやすいように。\n- 口コミ文だけを出力してください。`,
      "4": `300文字前後で、全体的に好印象で再訪したいというトーンの口コミを生成してください。\n- 接客・店内雰囲気などの印象を含めてください。\n- 口コミ文のみでお願いします。`,
      "5": `400文字前後で、非常に満足し他人にもおすすめしたいというトーンの口コミを生成してください。\n- 感情の動きや印象的なサービス体験を含めてください。\n- ポジティブで自然な日本語の口コミ文のみ出力してください。`
    };
  
    const values = Object.entries(formData).map(([k, v]) => `- ${k}: ${v}`).join("\n");
    const basePrompt = `以下はお客様が店舗でサービスを体験された際のアンケート回答内容です：\n${values}\n\n`;
    const prompt = basePrompt + promptMap[rating];
  
    console.log("生成されるプロンプト：", prompt);
  
    const reviewBox = document.getElementById("reviewText");
    reviewBox.value = "生成中...";
  
    try {
      const response = await fetch("/api/generate", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      const data = await response.json();
      reviewBox.value = data.result || "生成に失敗しました。";
    } catch (err) {
      console.error("エラー:", err);
      reviewBox.value = "エラーが発生しました。";
    }
  }
  </script>
  

</body>
</html>
