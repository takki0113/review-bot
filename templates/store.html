<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ store.store_name }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<section class="hero">
  <div class="hero-image">
    <img src="{{ store.hero_image }}" alt="店舗画像">
  </div>
  <div class="hero-text">
    <h1><span>ご来店ありがとうございます</span></h1>
    <p>アンケートのご協力をお願いします。</p>
  </div>
</section>

<section class="survey">
    <form id="review-form">
        {% for q in store.questions %}
          {% if q.type == "select" %}
          <div class="form-group">
            <label for="{{ q.id }}">{{ q.label }}</label>
            <select id="{{ q.id }}" name="{{ q.id }}">
              <option value="">選択してください</option>
              {% for opt in q.options %}
              <option value="{{ opt }}">{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          {% elif q.type == "textarea" %}
          <div class="form-group">
            <label for="{{ q.id }}">{{ q.label }}</label>
            <textarea id="{{ q.id }}" name="{{ q.id }}" rows="6" placeholder="{{ q.placeholder }}"></textarea>
          </div>
          {% endif %}
        {% endfor %}
      
        <div class="form-group">
          <button type="button" class="generate-btn" onclick="handleSubmit()">回答</button>
        </div>
      </form>
</section>

{% if store.google_link and store.store_link %}
<section class="result-section">
  <p class="result-label"><strong>こちらの口コミ案をよろしければお使いください</strong></p>
  <textarea class="result-box" id="reviewText"></textarea>
  <button class="copy-btn" onclick="copyToClipboard()">コピー</button>
  <div id="copyMessage" class="copy-message">コピーしました！</div>
  <div class="post-invite"><p><strong>こちらから投稿お願いします。</strong></p></div>
  <div class="link-buttons">
    <a href="{{ store.google_link }}" target="_blank">
      <img src="{{ store.google_img }}" alt="Google" class="post-icon-1">
    </a>
    <a href="{{ store.store_link }}" target="_blank">
        <img src="{{ store.store_logo }}" alt="投稿サイト" class="post-icon-2">
    </a>      
  </div>
</section>
{% endif %}

<footer class="footer">
  <p>{{ store.store_name }}</p>
</footer>

<script>
  function copyToClipboard() {
    const text = document.getElementById("reviewText").value;
    if (!text) return;
    navigator.clipboard.writeText(text).then(() => {
      const msg = document.getElementById("copyMessage");
      msg.classList.add("show");
      setTimeout(() => msg.classList.remove("show"), 1500);
    });
  }

  async function handleSubmit() {
  const formData = {};
  document.querySelectorAll("#review-form select, #review-form textarea").forEach(el => {
    formData[el.name] = el.value;
  });

  const ratingId = "評価点"; // ←ここを正しい質問IDに合わせてください
  const rating = formData[ratingId];

  if (!rating || !["1", "2", "3", "4", "5"].includes(rating)) {
    alert("評価点数が正しく入力されていません。");
    return;
  }

  const values = Object.entries(formData).map(([k, v]) => `- ${k}: ${v}`).join("\n");

  const basePrompt = `以下はお客様が店舗でサービスを体験された際のアンケート回答内容です。\n${values}\n\n`;

  const promptMap = {
  "1": `
100文字前後で、やや否定的で冷静なトーンの口コミを生成してください。
- 内容はおすすめしないことが伝わるもの。
- 感情的ではなく、事実や体験ベースで表現。
- 口コミ以外の余計な文言は含めないでください。
`,

  "2": `
100文字前後で、控えめに不満点を指摘する口コミを生成してください。
- 現時点ではおすすめしないトーン。
- 攻撃的ではなく、改善の余地を伝える表現。
- 口コミ以外の余計な文言は含めないでください。
`,

  "3": `
150文字前後で、良かった点と気になった点をバランスよく含めた口コミを生成してください。
- 利点と課題が両方書かれていること。
- 中立的なトーンを意識してください。
- 口コミ以外の余計な文言は含めないでください。
`,

  "4": `
300文字前後で、好印象を与える口コミを生成してください。
- スタッフの対応や店内の雰囲気なども自然に取り入れてください。
- 再訪したい気持ちが伝わるトーンで。
- 口コミ以外の余計な文言は含めないでください。
`,

  "5": `
400文字前後で、非常に満足し他人にも勧めたいという気持ちが伝わる口コミを生成してください。
- サービスの流れや自分の感情の変化なども盛り込んでください。
- 熱意が伝わるように、ポジティブかつ具体的な内容で構成してください。
- 口コミ以外の余計な文言は含めないでください。
`
};


  const prompt = `${basePrompt}${promptMap[rating]}\n口コミ以外の文言は不要です。`;

  const reviewBox = document.getElementById("reviewText");
  reviewBox.value = "生成中...";

  try {
    const response = await fetch("/api/generate", {
      method: "POST",
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
    const data = await response.json();
    reviewBox.value = data.result || "生成に失敗しました。";
  } catch (err) {
    console.error("エラー:", err);
    reviewBox.value = "エラーが発生しました。";
  }
}
</script>

</body>
</html>
