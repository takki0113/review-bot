<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ store.title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<section class="hero">
  <div class="hero-image">
    <img src="{{ store.hero_image }}" alt="店舗画像">
  </div>
  <div class="hero-text">
    <h1>{{ store.store_name }}<br><span>ご来店ありがとうございます</span></h1>
    <p>アンケートのご協力をお願いします。</p>
  </div>
</section>

<section class="survey">
    <form id="review-form">
        {% for q in store.questions %}
          {% if q.type == "select" %}
          <div class="form-group">
            <label for="{{ q.id }}">{{ q.label }}</label>
            <select id="{{ q.id }}" name="{{ q.id }}">
              <option value="">選択してください</option>
              {% for opt in q.options %}
              <option value="{{ opt }}">{{ opt }}</option>
              {% endfor %}
            </select>
          </div>
          {% elif q.type == "textarea" %}
          <div class="form-group">
            <label for="{{ q.id }}">{{ q.label }}</label>
            <textarea id="{{ q.id }}" name="{{ q.id }}" rows="6" placeholder="{{ q.placeholder }}"></textarea>
          </div>
          {% endif %}
        {% endfor %}
      
        <div class="form-group">
          <button type="button" class="generate-btn" onclick="handleSubmit()">回答</button>
        </div>
      </form>
</section>

<section class="result-section">
  <p class="result-label"><strong>こちらの口コミ案をよろしければお使いください</strong></p>
  <textarea class="result-box" id="reviewText"></textarea>
  <button class="copy-btn" onclick="copyToClipboard()">コピー</button>
  <div id="copyMessage" class="copy-message">コピーしました！</div>
  <div class="post-invite"><p><strong>こちらから投稿お願いします。</strong></p></div>
  <div class="link-buttons">
    <a href="{{ store.google_link }}" target="_blank">
      <img src="{{ store.google_img }}" alt="Google" class="post-icon-1">
    </a>
    <a href="{{ store.store_link }}" target="_blank">
        <img src="{{ store.store_logo }}" alt="投稿サイト" class="post-icon-2">
      </a>      
  </div>
</section>

<footer class="footer">
  <p>{{ store.store_name }}</p>
</footer>

<script>
  function copyToClipboard() {
    const text = document.getElementById("reviewText").value;
    if (!text) return;
    navigator.clipboard.writeText(text).then(() => {
      const msg = document.getElementById("copyMessage");
      msg.classList.add("show");
      setTimeout(() => msg.classList.remove("show"), 1500);
    });
  }

  async function handleSubmit() {
    const formData = {};
    document.querySelectorAll("#review-form select, #review-form textarea").forEach(el => {
      formData[el.name] = el.value;
    });

    const values = Object.entries(formData).map(([k, v]) => `- ${k}: ${v}`).join("\n");

    const prompt = `以下はお客様が店舗でサービスを体験された際のアンケート回答内容です。
    \n${values}\n\n
    この内容をもとに、実際に体験した一般のお客様が書いたような自然な日本語の口コミ文を1件のみ作成してください。  
    口コミの内容は、アンケート内に記載された「5点満点のうちの評価点数」に必ず一致させ、数値ではなくトーンや表現で評価を示してください。

    ――――――――――  
    ■ 評価別トーン・文字数  
    1点（冷静にやや否定的／おすすめしない）：100文字±5字  
    2点（控えめに不満点を指摘／現時点ではおすすめしない）：100文字±5字  
    3点（良い点と気になる点をバランス良く）：150文字±5字  
    4点（好印象・再訪前向き）：300文字±5字  
    5点（大満足・他人にすすめたい）：400文字±5字  

    ■ 出力時の必須ルール  
    - 必ず1つの評価点に基づく内容のみ。混在禁止。  
    - 口コミ以外の余計な文言を出力しない。  
    - 文字数チェック後、指定文字数に収まるまで以下を繰り返す：  
      1. 不足→店内の雰囲気／スタッフ対応／サービスの流れ／心情の変化などから具体的描写を想像で補完  
      2. 超過→冗長な表現を簡潔に言い換え  

    ――――――――――  
    ＜生成フロー＞  
    1. ルールに沿ってドラフトを作成  
    2. 文字数カウント＆該当範囲か確認  
    3. 不足なら想像で肉付け、超過なら削減  
    4. 手順2～3を条件を満たすまで繰り返し  
    5. 最終出力として口コミ文のみを表示し、末尾に「【文字数：○○文字】」を記載  

    ――――――――――  
    ※もし${values}だけでは情報が足りない場合、以下の観点を想像で補完して文字数を確保してください。  
    - 店内の雰囲気（インテリア、音楽、清潔感）  
    - スタッフの対応（挨拶、説明の丁寧さ、笑顔）  
    - サービスの流れ（受付→施術→アフターケア）  
    - 自身の心情（期待、驚き、安心感）  
    `; 
    const reviewBox = document.getElementById("reviewText");
    reviewBox.value = "生成中...";

    try {
      const response = await fetch("/api/generate", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      const data = await response.json();
      reviewBox.value = data.result || "生成に失敗しました。";
    } catch (err) {
      console.error("エラー:", err);
      reviewBox.value = "エラーが発生しました。";
    }
  }
</script>

</body>
</html>
